<!DOCTYPE html>
<html>
<head>
    <title>Expense Analyzer (ML)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<div class="container">

    <h1>Smart Expense Analyzer (ML)</h1>

    {% if error %}
        <p style="color: red; font-weight: bold;">
            Error: {{ error }}
        </p>
    {% endif %}

    <!-- ========= SINGLE EXPENSE ========= -->
    <h3>Analyze Single Expense</h3>

    <form method="POST">
        <input type="hidden" name="form_type" value="single">

        <input type="text" name="description" placeholder="e.g. uber ride" required>
        <br><br>
        <button type="submit">Analyze</button>
    </form>

    {% if predictions %}
        <h3>Top Predictions</h3>
        <ul>
            {% for category, confidence in predictions %}
                <li>
                    <strong>{{ category }}</strong> — {{ confidence }}%
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <hr>

    <!-- ========= CSV UPLOAD ========= -->
    <h3>Analyze CSV (Bulk Transactions)</h3>
    <p>CSV must contain a column named <strong>description</strong></p>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="form_type" value="csv">

        <input type="file" name="csv_file" accept=".csv" required>
        <br><br>
        <button type="submit">Analyze CSV</button>
    </form>

    {% if bulk_results %}
        <h3>CSV Results</h3>

        {% for item in bulk_results %}
            <div style="margin-bottom: 15px;">
                <strong>{{ item.description }}</strong>
                <ul>
                    {% for category, confidence in item.predictions %}
                        <li>{{ category }} — {{ confidence }}%</li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    {% endif %}

    {% if category_summary %}
        <hr>
        <h3>Category Summary</h3>

        <canvas id="barChart" width="400" height="200"></canvas>
        <br>
        <canvas id="pieChart" width="400" height="200"></canvas>
    {% endif %}


    {% if category_summary %}
        <hr>
        <form action="/download" method="GET">
            <button type="submit">Download Results as CSV</button>
        </form>
    {% endif %}

</div>
{% if category_summary %}
<script>
    const categoryData = {{ category_summary | tojson }};

    const labels = Object.keys(categoryData);
    const values = Object.values(categoryData);

    // BAR CHART
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Transactions',
                data: values
            }]
        }
    });

    // PIE CHART
    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values
            }]
        }
    });
</script>
{% endif %}

</body>
</html>
